name: Test (SwiftDTF)

on:
  push:
    paths:
      - "Package.swift"
      - "Package.resolved"
      - "Sources/**"
      - "Tests/**"
      - "README.md"
      - ".github/workflows/test.yml"
  pull_request:
    paths:
      - "Package.swift"
      - "Package.resolved"
      - "Sources/**"
      - "Tests/**"
      - "README.md"
      - ".github/workflows/test.yml"

jobs:
  test-linux-android:
    name: swift test (linux) + build (android)
    runs-on: ubuntu-latest
    env:
      HOST_TOOLCHAIN: main-snapshot-2025-12-17
      ANDROID_SDK_URL: https://download.swift.org/development/android-sdk/swift-DEVELOPMENT-SNAPSHOT-2025-12-17-a/swift-DEVELOPMENT-SNAPSHOT-2025-12-17-a_android.artifactbundle.tar.gz
      ANDROID_SDK_CHECKSUM: 5b5cd4da30ececb28c678c3a17a922f3c5fdb82f0ff6dc777bd44275fcc222e0
      ANDROID_SDK_ID: swift-DEVELOPMENT-SNAPSHOT-2025-12-17-a_android
      ANDROID_NDK_VERSION: r27d

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install libcurl4-openssl-dev unzip

      - name: Cache SwiftPM build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-linux-android-${{ env.HOST_TOOLCHAIN }}-${{ env.ANDROID_SDK_ID }}-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-linux-android-${{ env.HOST_TOOLCHAIN }}-${{ env.ANDROID_SDK_ID }}-

      - name: Install Swift snapshot + Android Swift SDK + NDK
        run: |
          set -euo pipefail

          # 1) Install Swiftly
          curl -fsSLO "https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz"
          tar zxf "swiftly-$(uname -m).tar.gz"
          ./swiftly init --quiet-shell-followup
          source ~/.local/share/swiftly/env.sh

          # 2) Install matching host toolchain.
          swiftly install "$HOST_TOOLCHAIN"
          swiftly use "$HOST_TOOLCHAIN"

          # Ensure the selected toolchain is on PATH for this step as well
          export PATH="$HOME/.local/share/swiftly/bin:$PATH"
          swift --version

          # Ensure Swift is available for later steps
          echo "$HOME/.local/share/swiftly/bin" >> "$GITHUB_PATH"

          # 3) Install the Swift SDK bundle for Android
          swift sdk install "$ANDROID_SDK_URL" --checksum "$ANDROID_SDK_CHECKSUM"

          # 4) Install Android NDK (required for cross-compilation)
          mkdir -p "$HOME/android-ndk"
          cd "$HOME/android-ndk"
          NDK_OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          curl -fSLO "https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-${NDK_OS}.zip"
          unzip -q "android-ndk-${ANDROID_NDK_VERSION}-"*.zip
          echo "ANDROID_NDK_HOME=$HOME/android-ndk/android-ndk-${ANDROID_NDK_VERSION}" >> "$GITHUB_ENV"

      - name: Configure Android NDK for Swift SDK
        run: |
          set -euo pipefail
          source ~/.local/share/swiftly/env.sh

          if [[ -z "${ANDROID_NDK_HOME:-}" ]]; then
            echo "ANDROID_NDK_HOME is not set; cannot configure Android builds." >&2
            exit 1
          fi

          # Determine NDK sysroot (contains standard C headers like assert.h/poll.h).
          NDK_PREBUILT_DIR="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          if [[ ! -d "$NDK_PREBUILT_DIR" ]]; then
            NDK_PREBUILT_DIR=$(find "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt" -maxdepth 1 -type d 2>/dev/null | head -n 1 || true)
          fi
          if [[ -z "$NDK_PREBUILT_DIR" || ! -d "$NDK_PREBUILT_DIR" ]]; then
            echo "Could not locate NDK prebuilt directory under $ANDROID_NDK_HOME" >&2
            exit 1
          fi
          SYSROOT="$NDK_PREBUILT_DIR/sysroot"
          if [[ ! -d "$SYSROOT/usr/include" ]]; then
            echo "NDK sysroot appears invalid: $SYSROOT" >&2
            exit 1
          fi

          # Persist for later build steps.
          echo "ANDROID_NDK_SYSROOT=$SYSROOT" >> "$GITHUB_ENV"

          # SwiftPM's default SDK install location on Linux is typically:
          #   ~/.config/swiftpm/swift-sdks
          # but older setups used:
          #   ~/.swiftpm/swift-sdks
          SWIFT_SDKS_DIR="$HOME/.config/swiftpm/swift-sdks"
          if [[ ! -d "$SWIFT_SDKS_DIR" ]]; then
            SWIFT_SDKS_DIR="$HOME/.swiftpm/swift-sdks"
          fi

          echo "SWIFT_SDKS_DIR=$SWIFT_SDKS_DIR" >> "$GITHUB_ENV"

          SWIFT_SDK_ROOT="$SWIFT_SDKS_DIR/${ANDROID_SDK_ID}.artifactbundle"

          # Older Android SDK bundles shipped a setup script at a fixed path.
          # Newer bundles may move/rename it, or may not require it at all.
          SETUP_SCRIPT_CANDIDATE="$SWIFT_SDK_ROOT/swift-android/scripts/setup-android-sdk.sh"
          SETUP_SCRIPT=""

          if [[ -f "$SETUP_SCRIPT_CANDIDATE" ]]; then
            SETUP_SCRIPT="$SETUP_SCRIPT_CANDIDATE"
          elif [[ -d "$SWIFT_SDK_ROOT" ]]; then
            # Try to discover a suitable setup script in the bundle.
            SETUP_SCRIPT=$(find "$SWIFT_SDK_ROOT" -type f \( \
              -name 'setup-android-sdk.sh' -o \
              -name 'setup-android-ndk.sh' -o \
              -name 'setup-android*.sh' \
            \) 2>/dev/null | head -n 1 || true)
          fi

          echo "Installed SDKs:"
          swift sdk list || true

          if [[ -n "$SETUP_SCRIPT" && -f "$SETUP_SCRIPT" ]]; then
            echo "Running Android SDK setup script: $SETUP_SCRIPT"
            export ANDROID_NDK_HOME
            bash "$SETUP_SCRIPT"
          else
            echo "No Android SDK setup script found in $SWIFT_SDK_ROOT; continuing without running one." >&2
            echo "If Android builds fail, inspect bundle contents with: find '$SWIFT_SDK_ROOT' -maxdepth 4 -type f -name '*setup*'" >&2
          fi

          # Some Swift Android SDK bundles expect a sysroot to exist at:
          #   <bundle>/swift-android/ndk-sysroot
          # If the helper script is missing or changed, create/update it ourselves.
          SWIFT_ANDROID_DIR="$SWIFT_SDK_ROOT/swift-android"
          if [[ ! -d "$SWIFT_ANDROID_DIR" ]]; then
            SWIFT_ANDROID_DIR=$(find "$SWIFT_SDK_ROOT" -maxdepth 3 -type d -name swift-android 2>/dev/null | head -n 1 || true)
          fi
          if [[ -n "$SWIFT_ANDROID_DIR" && -d "$SWIFT_ANDROID_DIR" ]]; then
            ln -sfn "$SYSROOT" "$SWIFT_ANDROID_DIR/ndk-sysroot"
            echo "Ensured Swift Android bundle sysroot: $SWIFT_ANDROID_DIR/ndk-sysroot -> $SYSROOT"
          else
            echo "Warning: could not locate swift-android directory inside $SWIFT_SDK_ROOT" >&2
          fi

          # Configure the installed Swift Android SDK to use the NDK sysroot for C/Clang builds.
          # This is required when the artifact bundle no longer ships a helper setup script.
          configure_target() {
            local swift_target_triple="$1"   # e.g. aarch64-unknown-linux-android28
            local ndk_triple="$2"           # e.g. aarch64-linux-android
            local api_level="$3"            # e.g. 28

            echo "Configuring Swift SDK '$ANDROID_SDK_ID' for target '$swift_target_triple' (NDK: $ndk_triple, API: $api_level)"

            # Swift SDK identifiers vary by Swift snapshot:
            # - Some expose per-target SDK IDs (e.g. "aarch64-unknown-linux-android28")
            # - Others expose a bundle SDK ID with a target triple selector
            if swift sdk configure "$swift_target_triple" \
                --sdk-root-path "$SYSROOT" \
                --include-search-path "$SYSROOT/usr/include" \
                --include-search-path "$SYSROOT/usr/include/$ndk_triple" \
                --library-search-path "$SYSROOT/usr/lib/$ndk_triple/$api_level"; then
              return 0
            fi

            swift sdk configure "$ANDROID_SDK_ID" "$swift_target_triple" \
              --sdk-root-path "$SYSROOT" \
              --include-search-path "$SYSROOT/usr/include" \
              --include-search-path "$SYSROOT/usr/include/$ndk_triple" \
              --library-search-path "$SYSROOT/usr/lib/$ndk_triple/$api_level"
          }

          configure_target aarch64-unknown-linux-android28 aarch64-linux-android 28
          configure_target x86_64-unknown-linux-android28 x86_64-linux-android 28

          echo "Swift SDK configuration (aarch64):"
          swift sdk configure --show-configuration "$ANDROID_SDK_ID" aarch64-unknown-linux-android28 || true

      - name: Swift version
        run: swift --version

      - name: Swift SDKs
        run: swift sdk list

      - name: Test (linux)
        run: swift test

      - name: Build for Android (aarch64)
        run: |
          set -euo pipefail
          swift build \
            --swift-sdk aarch64-unknown-linux-android28 \
            --swift-sdks-path "$SWIFT_SDKS_DIR" \
            --static-swift-stdlib \
            -Xcc --sysroot="$ANDROID_NDK_SYSROOT" \
            -Xcc -isystem -Xcc "$ANDROID_NDK_SYSROOT/usr/include" \
            -Xcc -isystem -Xcc "$ANDROID_NDK_SYSROOT/usr/include/aarch64-linux-android"

      - name: Build for Android (x86_64)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail
          swift build \
            --swift-sdk x86_64-unknown-linux-android28 \
            --swift-sdks-path "$SWIFT_SDKS_DIR" \
            --static-swift-stdlib \
            -Xcc --sysroot="$ANDROID_NDK_SYSROOT" \
            -Xcc -isystem -Xcc "$ANDROID_NDK_SYSROOT/usr/include" \
            -Xcc -isystem -Xcc "$ANDROID_NDK_SYSROOT/usr/include/x86_64-linux-android"

  test-macos:
    name: swift test (macos)
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Swift (latest) with Swiftly
        run: |
          set -euo pipefail
          curl -fsSLo swiftly.pkg "https://download.swift.org/swiftly/darwin/swiftly.pkg"
          installer -pkg swiftly.pkg -target CurrentUserHomeDirectory

          "$HOME/.swiftly/bin/swiftly" init --quiet-shell-followup
          . "${SWIFTLY_HOME_DIR:-$HOME/.swiftly}/env.sh"
          swiftly install --use latest

          # Ensure Swift is available for later steps
          echo "$HOME/.swiftly/bin" >> "$GITHUB_PATH"

          # Capture installed Swift version for cache keys/logging
          INSTALLED_VERSION=$(swift --version | awk '{print $3}' | head -1)
          echo "SWIFT_VERSION=$INSTALLED_VERSION" >> "$GITHUB_ENV"

      - name: Cache SwiftPM build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-swift-${{ env.SWIFT_VERSION }}-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-${{ env.SWIFT_VERSION }}-

      - name: Swift version
        run: swift --version

      - name: Test
        run: swift test
