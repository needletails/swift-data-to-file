name: Test (SwiftDTF)

on:
  push:
    paths:
      - "Package.swift"
      - "Package.resolved"
      - "Sources/**"
      - "Tests/**"
      - "README.md"
      - ".github/workflows/test.yml"
  pull_request:
    paths:
      - "Package.swift"
      - "Package.resolved"
      - "Sources/**"
      - "Tests/**"
      - "README.md"
      - ".github/workflows/test.yml"

jobs:
  test-macos:
    name: swift test (macos)
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Swift (latest) with Swiftly
        run: |
          set -euo pipefail
          curl -fsSLo swiftly.pkg "https://download.swift.org/swiftly/darwin/swiftly.pkg"
          installer -pkg swiftly.pkg -target CurrentUserHomeDirectory

          "$HOME/.swiftly/bin/swiftly" init --quiet-shell-followup
          . "${SWIFTLY_HOME_DIR:-$HOME/.swiftly}/env.sh"
          swiftly install --use latest

          # Ensure Swift is available for later steps
          echo "$HOME/.swiftly/bin" >> "$GITHUB_PATH"

          # Capture installed Swift version for cache keys/logging
          INSTALLED_VERSION=$(swift --version | awk '{print $3}' | head -1)
          echo "SWIFT_VERSION=$INSTALLED_VERSION" >> "$GITHUB_ENV"

      - name: Cache SwiftPM build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Swift version
        run: swift --version

      - name: Test
        run: swift test
